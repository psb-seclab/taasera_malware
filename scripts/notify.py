#!/usr/bin/python
import os
import time
import datetime
import sys
import paramiko
from scp import SCPClient
from os.path import expanduser

if len(sys.argv) != 3:
	print 'usage: notify.py [path to watch] [suffix]'
	exit(0)

server = '45.55.189.232'
port = 22
# not a good practice to embed credentials within a script
# needs to fix it in the future
user = 'taasera'
password = 'n0way2hack$'

dest_base_dir = "/home/taasera/taasera_malware_repository/"
today_str = datetime.date.today().isoformat() # date format: year-mm-dd
dest_path = os.path.join(dest_base_dir, today_str)
honeypot = sys.argv[2]
honey_list = ['dionaea', 'maltrieve', 'monkeynet']

if honeypot not in honey_list:
	print '[suffix] para has to be one of ', honey_list
	exit(0)

#path_to_watch = "/opt/dionaea/var/dionaea/binaries"
path_to_watch = sys.argv[1]
#home_dir = home = expanduser("~")
path_snapshot = os.path.join(path_to_watch, 'snapshot.txt')


def createSSHClient(server, port, user, password):
    client = paramiko.SSHClient()
    client.load_system_host_keys()
    client.set_missing_host_key_policy(paramiko.AutoAddPolicy())
    client.connect(server, port, user, password)
    return client

# making connetion to server
print 'Connecting to ' + server + '...'
ssh = createSSHClient(server, port, user, password)
scp = SCPClient(ssh.get_transport())
print 'Connected'

# get the snapshot took from yesterday
if not os.path.isfile(path_snapshot):
	tmp = open(path_snapshot, 'w') 
	tmp.close()

file_snapshot = open(path_snapshot, 'rt')
snapshot = file_snapshot.read().split('\n')
file_snapshot.close()

# today's snapshot
file_list = os.listdir(path_to_watch)

# delta contains the difference, i.e., the new downloads
delta = list(set(file_list) - set(snapshot))

print 'Samples go to', dest_path
print '# of samples to upload:', len(delta)-1
cnt = 0
new_snapshot = open(path_snapshot, 'a')
for f in delta:
	if f == 'snapshot.txt':
		continue
	cnt += 1
	print cnt, '\t[Put]', f
	# send it to sever
	scp.put(os.path.join(path_to_watch, f), 
		os.path.join(dest_path, f+'_'+honeypot))
	# append it to the current snapshot
	new_snapshot.write(f+'\n')
		
new_snapshot.close()

scp.close()